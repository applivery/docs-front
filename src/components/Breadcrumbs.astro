---
/**
 * Breadcrumbs Component - SEO & LLM Optimized
 *
 * Features for search engines and AI:
 * - Schema.org BreadcrumbList JSON-LD structured data
 * - Semantic HTML5 with <nav> and <ol>
 * - ARIA labels for accessibility
 * - Microdata attributes for rich snippets
 * - Heuristic path-based breadcrumb generation
 */

import { locales } from '../lib/i18n';

interface BreadcrumbItem {
  label: string;
  href: string;
  current?: boolean;
}

interface Props {
  items?: BreadcrumbItem[];
  currentPath?: string;
  currentTitle?: string;
  collection?: string;
  section?: string;
  category?: string;
  siteName?: string;
}

const {
  items,
  currentPath,
  currentTitle,
  collection,
  section,
  category,
  siteName = 'Documentation',
} = Astro.props;

/**
 * Heuristic breadcrumb generation from URL path
 * Converts: /docs/platform/workspaces/overview
 * To: Home > Platform > Workspaces > Overview (skips "docs")
 */
function generateBreadcrumbsFromPath(path: string): BreadcrumbItem[] {
  const breadcrumbs: BreadcrumbItem[] = [
    { label: 'Home', href: '/' }
  ];

  if (!path || path === '/') {
    return breadcrumbs;
  }

  // Clean and split the path
  const cleanPath = path.replace(/^\/|\/$/g, '').replace(/\/index$/, '');
  const segments = cleanPath.split('/').filter(Boolean);

  // Segments to hide from breadcrumb labels (but keep in href)
  // Hide 'docs' collection and all locale codes (en, es, fr, etc.)
  const hiddenSegments = ['docs', ...locales];

  // Build breadcrumb trail
  let currentHref = '';
  segments.forEach((segment, index) => {
    currentHref += `/${segment}`;
    const isLast = index === segments.length - 1;

    // Skip hidden segments (like "docs") from display
    if (hiddenSegments.includes(segment.toLowerCase())) {
      return;
    }

    // Format the label nicely
    const label = formatSegmentLabel(segment);

    breadcrumbs.push({
      label: isLast && currentTitle ? currentTitle : label,
      href: currentHref,
      current: isLast,
    });
  });

  return breadcrumbs;
}

/**
 * Format URL segment into human-readable label
 * Handles: kebab-case, snake_case, camelCase
 */
function formatSegmentLabel(segment: string): string {
  return segment
    // Replace hyphens and underscores with spaces
    .replace(/[-_]/g, ' ')
    // Add space before uppercase letters (camelCase)
    .replace(/([a-z])([A-Z])/g, '$1 $2')
    // Capitalize first letter of each word
    .replace(/\b\w/g, (c) => c.toUpperCase())
    // Handle common abbreviations
    .replace(/\bApi\b/g, 'API')
    .replace(/\bSdk\b/g, 'SDK')
    .replace(/\bCli\b/g, 'CLI')
    .replace(/\bUi\b/g, 'UI')
    .replace(/\bSso\b/g, 'SSO')
    .replace(/\bMdm\b/g, 'MDM')
    .replace(/\bEmm\b/g, 'EMM')
    .trim();
}

/**
 * Generate breadcrumbs from CMS metadata
 * Uses collection, section, category hierarchy
 */
function generateBreadcrumbsFromMetadata(): BreadcrumbItem[] {
  const breadcrumbs: BreadcrumbItem[] = [
    { label: 'Home', href: '/' }
  ];

  // Collections to hide from breadcrumb labels
  const hiddenCollections = ['docs'];

  // Add collection (e.g., docs, academy, insights) - skip hidden ones
  if (collection && !hiddenCollections.includes(collection.toLowerCase())) {
    const collectionLabel = formatSegmentLabel(collection);
    breadcrumbs.push({
      label: collectionLabel,
      href: `/${collection}`,
    });
  }

  // Add section if different from collection
  if (section && section !== collection) {
    const sectionLabel = formatSegmentLabel(section);
    breadcrumbs.push({
      label: sectionLabel,
      href: collection ? `/${collection}/${section.toLowerCase().replace(/\s+/g, '-')}` : `/${section.toLowerCase().replace(/\s+/g, '-')}`,
    });
  }

  // Add category if different from section
  if (category && category !== section) {
    const categoryLabel = formatSegmentLabel(category);
    breadcrumbs.push({
      label: categoryLabel,
      href: '#', // Category pages may not exist
    });
  }

  // Add current page
  if (currentTitle) {
    breadcrumbs.push({
      label: currentTitle,
      href: currentPath || '#',
      current: true,
    });
  }

  return breadcrumbs;
}

// Use provided items, or generate from path, or from metadata
let breadcrumbItems: BreadcrumbItem[];

if (items && items.length > 0) {
  breadcrumbItems = items;
} else if (currentPath) {
  breadcrumbItems = generateBreadcrumbsFromPath(currentPath);
} else {
  breadcrumbItems = generateBreadcrumbsFromMetadata();
}

// Generate JSON-LD structured data
const structuredData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbItems.map((item, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "name": item.label,
    "item": item.href.startsWith('http')
      ? item.href
      : `${Astro.site || ''}${item.href}`.replace(/([^:]\/)\/+/g, '$1')
  }))
};

// Generate plain text path for LLMs
const plainTextPath = breadcrumbItems.map(item => item.label).join(' > ');
---

<!-- JSON-LD Structured Data for SEO -->
<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

<!-- Hidden semantic content for LLMs and screen readers -->
<div class="sr-only" aria-hidden="false">
  <p>You are here: {plainTextPath}</p>
</div>

<nav
  class="breadcrumbs"
  aria-label="Breadcrumb navigation"
  itemscope
  itemtype="https://schema.org/BreadcrumbList"
>
  <ol class="breadcrumbs-list" role="list">
    {breadcrumbItems.map((item, index) => (
      <li
        class="breadcrumbs-item"
        itemprop="itemListElement"
        itemscope
        itemtype="https://schema.org/ListItem"
      >
        {index > 0 && (
          <svg
            class="breadcrumbs-separator"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        )}

        {item.current ? (
          <span
            class="breadcrumbs-current"
            itemprop="name"
            aria-current="page"
          >
            {item.label}
          </span>
        ) : (
          <a
            href={item.href}
            class:list={["breadcrumbs-link", { "breadcrumbs-home": index === 0 }]}
            itemprop="item"
          >
            {index === 0 ? (
              <>
                <svg
                  class="breadcrumbs-home-icon"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <path d="M3 11.9896V14.5C3 17.7998 3 19.4497 4.02513 20.4749C5.05025 21.5 6.70017 21.5 10 21.5H14C17.2998 21.5 18.9497 21.5 19.9749 20.4749C21 19.4497 21 17.7998 21 14.5V11.9896C21 10.3083 21 9.46773 20.6441 8.74005C20.2882 8.01237 19.6247 7.49628 18.2976 6.46411L16.2976 4.90855C14.2331 3.30285 13.2009 2.5 12 2.5C10.7991 2.5 9.76689 3.30285 7.70242 4.90855L5.70241 6.46411C4.37533 7.49628 3.71179 8.01237 3.3559 8.74005C3 9.46773 3 10.3083 3 11.9896Z" />
                  <path d="M15.0002 17C14.2007 17.6224 13.1504 18 12.0002 18C10.8499 18 9.79971 17.6224 9.00018 17" />
                </svg>
                <span class="sr-only" itemprop="name">{item.label}</span>
              </>
            ) : (
              <span itemprop="name">{item.label}</span>
            )}
          </a>
        )}

        <meta itemprop="position" content={String(index + 1)} />
      </li>
    ))}
  </ol>
</nav>

<style>
  .breadcrumbs {
    margin-bottom: 1rem;
  }

  .breadcrumbs-list {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.25rem;
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 0.875rem;
  }

  .breadcrumbs-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .breadcrumbs-separator {
    width: 1rem;
    height: 1rem;
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  .breadcrumbs-link {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
    white-space: nowrap;
  }

  .breadcrumbs-link:hover {
    color: var(--color-primary);
  }

  .breadcrumbs-current {
    color: var(--color-text-secondary);
    font-weight: 500;
    /* Truncate long titles on mobile */
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  @media (min-width: 640px) {
    .breadcrumbs-current {
      max-width: 400px;
    }
  }

  /* Home icon styling */
  .breadcrumbs-home {
    display: flex;
    align-items: center;
  }

  .breadcrumbs-home-icon {
    width: 1.125rem;
    height: 1.125rem;
    color: var(--color-text-muted);
    transition: color var(--transition-fast);
  }

  .breadcrumbs-home:hover .breadcrumbs-home-icon {
    color: var(--color-primary);
  }

  :global(.dark) .breadcrumbs-home-icon {
    color: var(--color-text-muted);
  }

  :global(.dark) .breadcrumbs-home:hover .breadcrumbs-home-icon {
    color: var(--color-primary);
  }

  /* Screen reader only content */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
