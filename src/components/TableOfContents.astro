---
/**
 * TableOfContents Component - SEO & LLM Optimized (Heuristic)
 *
 * SEO Features:
 * - Schema.org ItemList JSON-LD for rich snippets
 * - HowTo schema for tutorial/guide content (heuristic detection)
 * - FAQPage schema for Q&A style headings (heuristic detection)
 * - SpeakableSpecification for voice search
 * - Microdata attributes on navigation elements
 * - Semantic HTML5 with proper ARIA
 *
 * LLM Features:
 * - Hidden semantic document outline for AI crawlers
 * - Hierarchical structure representation
 * - Topic summary for context understanding
 */

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
  pageTitle?: string;
}

const { headings, pageTitle } = Astro.props;

// Build hierarchical structure
interface TocNode {
  heading: Heading;
  children: TocNode[];
}

function buildHierarchy(headings: Heading[]): TocNode[] {
  const root: TocNode[] = [];
  let currentH2: TocNode | null = null;

  for (const heading of headings) {
    const node: TocNode = { heading, children: [] };

    if (heading.depth === 2) {
      root.push(node);
      currentH2 = node;
    } else if (heading.depth === 3 && currentH2) {
      currentH2.children.push(node);
    } else {
      root.push(node);
    }
  }

  return root;
}

const hierarchy = buildHierarchy(headings);
const totalSections = headings.length;
const h2Count = hierarchy.length;

// Heuristic: Detect if content is FAQ-style (questions)
const questionPattern = /^(what|how|why|when|where|who|which|can|does|is|are|should|would|could)\b/i;
const questionHeadings = headings.filter(h => questionPattern.test(h.text) || h.text.includes('?'));
const isFAQStyle = questionHeadings.length >= 2 && questionHeadings.length >= headings.length * 0.5;

// Heuristic: Detect if content is tutorial/guide style (steps, numbered)
const stepPattern = /^(step|part|phase|stage|\d+[\.\):])/i;
const actionPattern = /^(how to|getting started|setup|install|configure|create|build|implement)/i;
const isTutorialStyle = headings.some(h => stepPattern.test(h.text) || actionPattern.test(h.text));

// Generate JSON-LD: ItemList (always)
const itemListSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Table of Contents",
  "description": pageTitle ? `Document sections for: ${pageTitle}` : "Document sections",
  "numberOfItems": totalSections,
  "itemListElement": headings.map((h, i) => ({
    "@type": "ListItem",
    "position": i + 1,
    "name": h.text,
    "url": `#${h.slug}`
  }))
};

// Generate JSON-LD: HowTo (for tutorials)
const howToSchema = isTutorialStyle ? {
  "@context": "https://schema.org",
  "@type": "HowTo",
  "name": pageTitle || "Guide",
  "step": hierarchy.map((node, i) => ({
    "@type": "HowToStep",
    "position": i + 1,
    "name": node.heading.text,
    "url": `#${node.heading.slug}`,
    ...(node.children.length > 0 && {
      "itemListElement": node.children.map((child, j) => ({
        "@type": "HowToDirection",
        "position": j + 1,
        "text": child.heading.text
      }))
    })
  }))
} : null;

// Generate JSON-LD: FAQPage (for Q&A content)
const faqSchema = isFAQStyle ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": questionHeadings.slice(0, 10).map(h => ({
    "@type": "Question",
    "name": h.text,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": `See section: ${h.text}`
    }
  }))
} : null;

// Generate JSON-LD: SpeakableSpecification (for voice search)
const speakableSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "speakable": {
    "@type": "SpeakableSpecification",
    "cssSelector": ["h1", "h2", ".article-description", ".tldr-content"]
  }
};

// Plain text outline for LLMs (hierarchical)
const plainTextOutline = hierarchy.map((node, i) => {
  let outline = `${i + 1}. ${node.heading.text}`;
  if (node.children.length > 0) {
    outline += '\n' + node.children.map((child, j) =>
      `   ${i + 1}.${j + 1}. ${child.heading.text}`
    ).join('\n');
  }
  return outline;
}).join('\n');

// Extract key topics for LLM context
const keyTopics = headings
  .map(h => h.text)
  .join(', ')
  .slice(0, 500);
---

<!-- JSON-LD Structured Data -->
<script type="application/ld+json" set:html={JSON.stringify(itemListSchema)} />
{howToSchema && <script type="application/ld+json" set:html={JSON.stringify(howToSchema)} />}
{faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}
<script type="application/ld+json" set:html={JSON.stringify(speakableSchema)} />

<!-- Hidden semantic content for LLMs and screen readers -->
<div class="sr-only" aria-hidden="false" role="navigation" aria-label="Document structure">
  <h2>Document Outline</h2>
  <p>This document contains {h2Count} main sections and {totalSections} total headings.</p>
  {isTutorialStyle && <p>Content type: Tutorial/Guide with step-by-step instructions.</p>}
  {isFAQStyle && <p>Content type: FAQ with {questionHeadings.length} questions answered.</p>}
  <p>Key topics covered: {keyTopics}</p>
  <h3>Section hierarchy:</h3>
  <pre>{plainTextOutline}</pre>
</div>

<aside
  class="toc"
  role="complementary"
  aria-label="Table of contents"
  id="toc-aside"
  itemscope
  itemtype="https://schema.org/WPSideBar"
>
  <div class="toc-title">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <path d="M4 6h16M4 12h16M4 18h7"/>
    </svg>
    <span>On this page</span>
  </div>

  <!-- Progress bar -->
  <div class="toc-progress" role="progressbar" aria-label="Reading progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
    <div class="toc-progress-bar" id="toc-progress-bar"></div>
  </div>

  <nav
    class="toc-list"
    id="toc-nav"
    aria-label="Page sections"
    itemscope
    itemtype="https://schema.org/SiteNavigationElement"
  >
    <ol role="list">
      {hierarchy.map((node, idx) => (
        <li
          itemprop="hasPart"
          itemscope
          itemtype="https://schema.org/WebPageElement"
        >
          <a
            href={`#${node.heading.slug}`}
            class="toc-item"
            data-slug={node.heading.slug}
            itemprop="url"
            aria-label={`Section ${idx + 1}: ${node.heading.text}`}
          >
            <span itemprop="name">{node.heading.text}</span>
          </a>
          <meta itemprop="position" content={String(idx + 1)} />
          {node.children.length > 0 && (
            <ol role="list" aria-label={`Subsections of ${node.heading.text}`}>
              {node.children.map((child, childIdx) => (
                <li
                  itemprop="hasPart"
                  itemscope
                  itemtype="https://schema.org/WebPageElement"
                >
                  <a
                    href={`#${child.heading.slug}`}
                    class="toc-item toc-item-sub"
                    data-slug={child.heading.slug}
                    itemprop="url"
                    aria-label={`Subsection ${idx + 1}.${childIdx + 1}: ${child.heading.text}`}
                  >
                    <span itemprop="name">{child.heading.text}</span>
                  </a>
                  <meta itemprop="position" content={`${idx + 1}.${childIdx + 1}`} />
                </li>
              ))}
            </ol>
          )}
        </li>
      ))}
    </ol>
  </nav>

  <!-- Quick actions -->
  <div class="toc-actions">
    <button type="button" class="toc-action-btn" id="toc-top-btn" title="Scroll to top" aria-label="Scroll to top of page">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M12 19V5M5 12l7-7 7 7"/>
      </svg>
      Top
    </button>
    <button type="button" class="toc-action-btn" id="toc-copy-btn" title="Copy link" aria-label="Copy page link to clipboard">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <rect x="9" y="9" width="13" height="13" rx="2"/>
        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
      </svg>
      Copy
    </button>
  </div>
</aside>

<script>
  function initTableOfContents() {
    const toc = document.getElementById('toc-aside');
    const tocNav = document.getElementById('toc-nav');
    const progressBar = document.getElementById('toc-progress-bar');
    const progressContainer = progressBar?.parentElement;
    const topBtn = document.getElementById('toc-top-btn');
    const copyBtn = document.getElementById('toc-copy-btn');

    if (!toc || !tocNav) return;

    const tocLinks = tocNav.querySelectorAll<HTMLAnchorElement>('a[data-slug]');
    const headingIds = Array.from(tocLinks).map(link => link.dataset.slug).filter(Boolean) as string[];
    const headings = headingIds.map(id => document.getElementById(id)).filter(Boolean) as HTMLElement[];

    if (headings.length === 0) return;

    let currentActive: string | null = null;

    // Find the scrollable container (.article-main)
    const scrollContainer = document.querySelector('.article-main') as HTMLElement | null;

    // Scroll to top
    topBtn?.addEventListener('click', () => {
      if (scrollContainer) {
        scrollContainer.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });

    // Copy link
    copyBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M20 6L9 17l-5-5"/></svg> Copied!`;
        setTimeout(() => {
          copyBtn.innerHTML = originalHTML;
        }, 1500);
      } catch (e) {
        console.error('Copy failed', e);
      }
    });

    // Click handler for TOC links - smooth scroll with offset
    tocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const slug = link.dataset.slug;
        if (!slug) return;

        const target = document.getElementById(slug);
        if (target && scrollContainer) {
          const offset = 100;
          const containerRect = scrollContainer.getBoundingClientRect();
          const targetRect = target.getBoundingClientRect();
          const top = scrollContainer.scrollTop + (targetRect.top - containerRect.top) - offset;
          scrollContainer.scrollTo({ top, behavior: 'smooth' });
          history.pushState(null, '', `#${slug}`);
        } else if (target) {
          const offset = 100;
          const top = target.getBoundingClientRect().top + window.scrollY - offset;
          window.scrollTo({ top, behavior: 'smooth' });
          history.pushState(null, '', `#${slug}`);
        }
      });
    });

    // Track active section with IntersectionObserver
    const observer = new IntersectionObserver(
      (entries) => {
        let topVisibleId: string | null = null;
        let topY = Infinity;

        entries.forEach(entry => {
          if (entry.isIntersecting && entry.boundingClientRect.top < topY) {
            topY = entry.boundingClientRect.top;
            topVisibleId = (entry.target as HTMLElement).id;
          }
        });

        if (topVisibleId && topVisibleId !== currentActive) {
          currentActive = topVisibleId;
          tocLinks.forEach(link => {
            const isActive = link.dataset.slug === topVisibleId;
            link.classList.toggle('active', isActive);
            link.setAttribute('aria-current', isActive ? 'true' : 'false');
          });
        }
      },
      { root: scrollContainer, rootMargin: '-80px 0px -70% 0px', threshold: 0 }
    );

    headings.forEach(h => observer.observe(h));

    // Progress bar
    function updateProgress() {
      if (!progressBar || !progressContainer) return;

      if (scrollContainer) {
        const scrollTop = scrollContainer.scrollTop;
        const scrollHeight = scrollContainer.scrollHeight - scrollContainer.clientHeight;
        const progress = scrollHeight > 0 ? Math.min(100, Math.max(0, Math.round((scrollTop / scrollHeight) * 100))) : 0;
        progressBar.style.width = `${progress}%`;
        progressContainer.setAttribute('aria-valuenow', String(progress));
      } else {
        const article = document.querySelector('article');
        if (!article) return;
        const rect = article.getBoundingClientRect();
        const articleTop = rect.top + window.scrollY;
        const articleHeight = rect.height;
        const scrolled = window.scrollY - articleTop + window.innerHeight * 0.3;
        const progress = Math.min(100, Math.max(0, Math.round((scrolled / articleHeight) * 100)));
        progressBar.style.width = `${progress}%`;
        progressContainer.setAttribute('aria-valuenow', String(progress));
      }
    }

    let ticking = false;
    const scrollTarget = scrollContainer || window;
    scrollTarget.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateProgress();
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });

    updateProgress();

    // Handle initial hash
    if (window.location.hash) {
      const target = document.getElementById(window.location.hash.slice(1));
      if (target && scrollContainer) {
        setTimeout(() => {
          const offset = 100;
          const containerRect = scrollContainer.getBoundingClientRect();
          const targetRect = target.getBoundingClientRect();
          const top = scrollContainer.scrollTop + (targetRect.top - containerRect.top) - offset;
          scrollContainer.scrollTo({ top, behavior: 'smooth' });
        }, 100);
      } else if (target) {
        setTimeout(() => {
          const offset = 100;
          const top = target.getBoundingClientRect().top + window.scrollY - offset;
          window.scrollTo({ top, behavior: 'smooth' });
        }, 100);
      }
    }

    return () => observer.disconnect();
  }

  // Run on load and Astro navigation
  initTableOfContents();
  document.addEventListener('astro:after-swap', initTableOfContents);
</script>

<style>
  .toc {
    position: sticky;
    top: 1rem;
    width: 14rem;
    max-height: calc(100vh - 8rem);
    display: none;
    flex-direction: column;
    flex-shrink: 0;
    padding-left: 1.5rem;
  }

  @media (min-width: 1024px) {
    .toc {
      display: flex;
    }
  }

  .toc-title {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .toc-progress {
    height: 2px;
    background: var(--color-border-light, #e5e7eb);
    border-radius: 1px;
    margin-bottom: 0.75rem;
    overflow: hidden;
  }

  .toc-progress-bar {
    height: 100%;
    width: 0;
    background: var(--color-primary);
    transition: width 0.1s ease-out;
  }

  .toc-list {
    flex: 1;
    overflow-y: auto;
    padding-left: 0;
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
  }

  .toc-list::-webkit-scrollbar {
    width: 6px;
  }

  .toc-list::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc-list::-webkit-scrollbar-thumb {
    background-color: transparent;
    border-radius: 9999px;
  }

  .toc-list:hover {
    scrollbar-color: var(--color-border) transparent;
  }

  .toc-list:hover::-webkit-scrollbar-thumb {
    background-color: var(--color-border);
  }

  .toc-list ol {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .toc-list ol ol {
    margin: 0.125rem 0 0.25rem 0;
    padding-left: 0.75rem;
  }

  .toc-item {
    display: block;
    font-size: 0.8125rem;
    line-height: 1.5;
    color: var(--color-text-muted);
    padding: 0.25rem 0;
    padding-left: 0.75rem;
    text-decoration: none;
    transition: color 0.15s ease, border-color 0.15s ease;
    border-left: 2px solid transparent;
    margin-left: -1px;
  }

  .toc-item:hover {
    color: var(--color-text-primary);
  }

  .toc-item.active {
    color: var(--color-primary);
    font-weight: 500;
    border-left-color: var(--color-primary);
  }

  .toc-item-sub {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .toc-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
  }

  .toc-action-btn {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.625rem;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    background: none;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: color 0.15s, background-color 0.15s;
  }

  .toc-action-btn:hover {
    color: var(--color-primary);
    background-color: var(--color-primary-10, rgba(59, 130, 246, 0.1));
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
