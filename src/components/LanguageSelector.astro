---
/**
 * Smart Language Selector Component
 *
 * Features:
 * - Only shows languages that have translations for the current document
 * - Shows "Only available in {language}" when no translations exist
 * - Preserves the current path when switching languages
 */

import {
  locales,
  localeNames,
  localizedPath,
  removeLocaleFromPath,
  type Locale
} from '../lib/i18n';

interface Props {
  /** Current locale */
  currentLocale: Locale;
  /** Current URL path */
  currentPath: string;
  /** List of locales that have translations for this document */
  availableTranslations?: Locale[];
  /** Optional: mapping of locale to translated slug for this document */
  translationSlugs?: Partial<Record<Locale, string>>;
  /** Size variant */
  size?: 'sm' | 'md';
  /** Show full language names or just codes */
  showNames?: boolean;
  /** Dropdown position: 'top' opens above button, 'bottom' opens below */
  dropdownPosition?: 'top' | 'bottom';
}

const {
  currentLocale,
  currentPath,
  availableTranslations = [currentLocale],
  translationSlugs = {},
  size = 'md',
  showNames = true,
  dropdownPosition = 'top',
} = Astro.props;

// Get the path without locale for building new URLs
const pathWithoutLocale = removeLocaleFromPath(currentPath);

// Build the URL for each locale
function getLocaleUrl(locale: Locale): string {
  // If we have a specific translated slug for this locale, use it
  if (translationSlugs[locale]) {
    return `/${locale}/${translationSlugs[locale]}`;
  }
  // Otherwise, keep the same path structure
  return localizedPath(pathWithoutLocale, locale);
}

// Filter to only show locales that have translations
const displayLocales = locales.filter(locale =>
  availableTranslations.includes(locale)
);

// Check if there are translations available (more than just current locale)
const hasTranslations = displayLocales.length > 1;

// Size classes
const sizeClasses = {
  sm: {
    button: 'px-2 py-1 text-xs gap-1',
    icon: 'w-3.5 h-3.5',
    chevron: 'w-2.5 h-2.5',
    dropdown: 'min-w-[120px] py-1',
    option: 'px-2 py-1 text-xs',
  },
  md: {
    button: 'px-3 py-1.5 text-sm gap-1.5',
    icon: 'w-4 h-4',
    chevron: 'w-3 h-3',
    dropdown: 'min-w-[160px] py-1.5',
    option: 'px-3 py-1.5 text-sm',
  },
};

const classes = sizeClasses[size];
---

<div class="language-selector relative" data-language-selector>
  <button
    class={`language-btn flex items-center ${classes.button} rounded-md border border-[var(--color-border)] bg-[var(--color-background)] text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] hover:border-[var(--color-text-muted)] transition-all`}
    data-language-toggle
    aria-expanded="false"
    aria-haspopup="listbox"
    aria-label="Select language"
  >
    <!-- Globe icon -->
    <svg class={classes.icon} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"/>
      <line x1="2" y1="12" x2="22" y2="12"/>
      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
    </svg>

    <span class="language-code font-semibold">{currentLocale.toUpperCase()}</span>

    <!-- Chevron -->
    <svg class={`language-chevron ${classes.chevron} transition-transform`} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="6 9 12 15 18 9"/>
    </svg>
  </button>

  <div
    class={`language-dropdown absolute left-0 ${dropdownPosition === 'top' ? 'bottom-full mb-2' : 'top-full mt-2'} ${classes.dropdown} bg-[var(--color-background)] border border-[var(--color-border)] rounded-lg shadow-lg opacity-0 invisible transform ${dropdownPosition === 'top' ? 'translate-y-2' : '-translate-y-2'} transition-all z-50`}
    data-language-dropdown
    data-position={dropdownPosition}
    role="listbox"
    aria-label="Available languages"
  >
    {hasTranslations ? (
      <>
        {displayLocales.map(locale => (
          <a
            href={getLocaleUrl(locale)}
            class={`language-option flex items-center gap-2 ${classes.option} ${locale === currentLocale ? 'text-[var(--color-primary)] bg-[var(--color-primary)]/5 font-medium' : 'text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] hover:bg-[var(--color-background-secondary)]'} transition-colors`}
            role="option"
            aria-selected={locale === currentLocale}
            data-locale={locale}
          >
            <span class="locale-code font-semibold w-6">{locale.toUpperCase()}</span>
            {showNames && (
              <span class="locale-name flex-1 text-[var(--color-text-muted)]">{localeNames[locale]}</span>
            )}
            {locale === currentLocale && (
              <svg class="w-4 h-4 text-[var(--color-primary)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            )}
          </a>
        ))}
      </>
    ) : (
      <div class={`no-translations ${classes.option} text-[var(--color-text-muted)] text-center`}>
        <span>Only available in {localeNames[currentLocale]}</span>
      </div>
    )}

  </div>
</div>

<style>
  .language-selector {
    position: relative;
  }

  .language-dropdown {
    /* Ensure dropdown is on top of everything */
    z-index: 9999 !important;
    /* Use same background as main content container */
    background-color: var(--color-bg-primary, #ffffff) !important;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }

  :global(.dark) .language-dropdown {
    /* Dark mode: use same background as main content container */
    background-color: var(--color-bg-primary, #0b1220) !important;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
  }

  .language-selector.open .language-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .language-selector.open .language-chevron {
    transform: rotate(180deg);
  }

  .language-btn:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-light);
  }

  .language-option {
    text-decoration: none;
    display: flex;
  }

  /* Position dropdown above on mobile if needed */
  @media (max-height: 500px) {
    .language-dropdown[data-position="top"] {
      bottom: auto;
      top: 100%;
      margin-bottom: 0;
      margin-top: 0.5rem;
    }
  }
</style>

<script>
  function initLanguageSelectors() {
    document.querySelectorAll('[data-language-selector]').forEach(selector => {
      const toggle = selector.querySelector('[data-language-toggle]') as HTMLButtonElement;
      const dropdown = selector.querySelector('[data-language-dropdown]');

      if (!toggle || !dropdown) return;

      // Toggle dropdown
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = selector.classList.toggle('open');
        toggle.setAttribute('aria-expanded', String(isOpen));
      });

      // Keyboard navigation
      toggle.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          selector.classList.remove('open');
          toggle.setAttribute('aria-expanded', 'false');
          toggle.focus();
        } else if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selector.classList.add('open');
          toggle.setAttribute('aria-expanded', 'true');
          // Focus first option
          const firstOption = dropdown.querySelector('a[role="option"]') as HTMLAnchorElement;
          firstOption?.focus();
        }
      });

      // Arrow key navigation within dropdown
      dropdown.addEventListener('keydown', (e) => {
        const event = e as KeyboardEvent;
        const options = Array.from(dropdown.querySelectorAll('a[role="option"]')) as HTMLAnchorElement[];
        const currentIndex = options.findIndex(opt => opt === document.activeElement);

        if (event.key === 'ArrowDown') {
          event.preventDefault();
          const nextIndex = (currentIndex + 1) % options.length;
          options[nextIndex]?.focus();
        } else if (event.key === 'ArrowUp') {
          event.preventDefault();
          const prevIndex = currentIndex <= 0 ? options.length - 1 : currentIndex - 1;
          options[prevIndex]?.focus();
        } else if (event.key === 'Escape') {
          selector.classList.remove('open');
          toggle.setAttribute('aria-expanded', 'false');
          toggle.focus();
        }
      });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      document.querySelectorAll('[data-language-selector]').forEach(selector => {
        if (!selector.contains(target)) {
          selector.classList.remove('open');
          const toggle = selector.querySelector('[data-language-toggle]') as HTMLButtonElement;
          toggle?.setAttribute('aria-expanded', 'false');
        }
      });
    });
  }

  // Initialize on page load
  initLanguageSelectors();

  // Re-initialize after view transitions (if using Astro View Transitions)
  document.addEventListener('astro:after-swap', initLanguageSelectors);
</script>
