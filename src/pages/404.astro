---
/**
 * Custom 404 - Page Not Found
 * Uses home page layout for consistent experience
 */

import BaseLayout from '../layouts/BaseLayout.astro';
import Icon from '../components/Icon';
import { getAllSettings, type HomeSettings, type LocalizedText, type NavigationSettings } from '../lib/cms';
import {
  locales,
  localeNames,
  defaultLocale,
  type Locale
} from '../lib/i18n';

// Helper to get localized text with fallback
function getLocalizedText(text: LocalizedText | undefined, locale: Locale, fallback: string = ''): string {
  if (!text) return fallback;
  return text[locale] || text.en || fallback;
}

let settings = null;
try {
  settings = await getAllSettings();
} catch (error) {
  // Silently fail - use defaults
}

const homeSettings = settings?.home;
const siteName = settings?.seo?.siteName || 'Documentation';
const locale = defaultLocale;

// Extract icon mapping from sideMenu settings
const navigation = settings?.navigation as NavigationSettings | undefined;
const sideMenu = navigation?.sideMenu;
const collectionIcons: Record<string, string> = {};
if (sideMenu?.items) {
  sideMenu.items.forEach((item) => {
    if (item.collection && item.icon) {
      collectionIcons[item.collection] = item.icon;
    }
  });
}

// Detect available locales from home settings translations
function getAvailableLocalesFromSettings(home: HomeSettings | null | undefined): Locale[] {
  if (!home) return [defaultLocale];

  const foundLocales = new Set<string>();

  const checkLocalizedText = (text: LocalizedText | undefined) => {
    if (!text) return;
    for (const [key, value] of Object.entries(text)) {
      if (value && typeof value === 'string' && value.trim() !== '') {
        foundLocales.add(key);
      }
    }
  };

  checkLocalizedText(home.hero?.title);
  checkLocalizedText(home.hero?.highlightedWord);
  checkLocalizedText(home.hero?.subtitle);
  checkLocalizedText(home.hero?.searchPlaceholder);
  checkLocalizedText(home.hero?.ctaButton?.label);
  home.headerNav?.forEach(item => checkLocalizedText(item.label));
  home.quickLinks?.forEach(link => checkLocalizedText(link.label));
  checkLocalizedText(home.featuredArticles?.title);
  checkLocalizedText(home.footer?.tagline);

  const availableLocales = locales.filter(l => foundLocales.has(l));
  return availableLocales.length > 0 ? availableLocales : [defaultLocale];
}

const availableLocales = getAvailableLocalesFromSettings(homeSettings);

// Header navigation from CMS
const headerNavItems = homeSettings?.headerNav || [];

const CMS_URL = import.meta.env.CMS_URL || 'http://localhost:3000';
const CMS_API_KEY = import.meta.env.CMS_API_KEY || '';

// Footer content from CMS
const footerTagline = getLocalizedText(homeSettings?.footer?.tagline, locale, 'Built with DocForge and Astro');
const socialLinks = homeSettings?.footer?.socialLinks || [];

// Social link icons
const socialIcons: Record<string, string> = {
  github: 'M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z',
  twitter: 'M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z',
  linkedin: 'M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z',
  discord: 'M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189Z',
  youtube: 'M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z',
};

// Helper to build localized URL
function localizeUrl(path: string): string {
  return `/${locale}${path.startsWith('/') ? path : '/' + path}`;
}
---

<BaseLayout title={`Page Not Found - ${siteName}`} description="The page you're looking for doesn't exist." locale={locale}>
  <div class="min-h-screen bg-[var(--color-background)] flex flex-col"
    data-cms-url={CMS_URL}
    data-cms-api-key={CMS_API_KEY}
    data-collection-icons={JSON.stringify(collectionIcons)}
  >
    <!-- Header (same as home page) -->
    <header id="site-header" class="fixed top-0 left-0 right-0 h-16 bg-[var(--color-background)]/80 backdrop-blur-md border-b border-[var(--color-border)] z-50 transition-transform duration-300">
      <div class="max-w-7xl mx-auto px-6 h-full flex items-center justify-between">
        <!-- Logo -->
        <a href={localizeUrl('/')} class="flex items-center gap-3">
          {(settings?.appearance?.branding?.logo || settings?.appearance?.logoUrl) ? (
            <div class="sidebar-logo">
              <img
                src={settings?.appearance?.branding?.logo || settings?.appearance?.logoUrl}
                alt={siteName}
                class={`logo-light ${settings?.appearance?.branding?.logoDark ? 'dark:hidden' : ''}`}
                style={`max-width: ${settings?.appearance?.branding?.logoWidth || 120}px; max-height: ${settings?.appearance?.branding?.logoHeight || 32}px; height: auto;`}
              />
              {settings?.appearance?.branding?.logoDark && (
                <img
                  src={settings?.appearance?.branding?.logoDark}
                  alt={siteName}
                  class="logo-dark hidden dark:block"
                  style={`max-width: ${settings?.appearance?.branding?.logoWidth || 120}px; max-height: ${settings?.appearance?.branding?.logoHeight || 32}px; height: auto;`}
                />
              )}
            </div>
          ) : (
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-lg bg-[var(--color-primary)] flex items-center justify-center">
                <Icon name="fileText" className="w-5 h-5 text-white" aria-hidden={true} client:only="react" />
              </div>
              <span class="font-semibold text-[var(--color-text-primary)]">{siteName}</span>
            </div>
          )}
        </a>

        <!-- Navigation -->
        <nav class="hidden md:flex items-center gap-6">
          {headerNavItems.length > 0 ? (
            headerNavItems.map(item => (
              <a
                href={item.external ? item.href : localizeUrl(item.href)}
                target={item.external ? '_blank' : undefined}
                rel={item.external ? 'noopener noreferrer' : undefined}
                class="text-sm font-medium text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]"
              >
                {getLocalizedText(item.label, locale, '')}
              </a>
            ))
          ) : (
            <>
              <a href={localizeUrl('/docs')} class="text-sm font-medium text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]">Documentation</a>
              <a href={localizeUrl('/academy')} class="text-sm font-medium text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]">Guides</a>
              <a href={localizeUrl('/api')} class="text-sm font-medium text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]">API Reference</a>
            </>
          )}
        </nav>

        <!-- Actions -->
        <div class="flex items-center gap-4">
          <!-- Language selector -->
          {availableLocales.length > 1 && (
            <div class="language-selector relative" data-language-selector>
              <button
                class="flex items-center gap-1.5 px-2 py-1.5 text-sm text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] rounded-md hover:bg-[var(--color-background-secondary)]"
                data-language-toggle
              >
                <Icon name="language" className="w-4 h-4" aria-hidden={true} client:only="react" />
                <span class="font-medium">{locale.toUpperCase()}</span>
                <Icon name="chevronDown" className="w-3 h-3" aria-hidden={true} client:only="react" />
              </button>
              <div class="language-dropdown absolute right-0 top-full mt-1 min-w-[140px] py-1 bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg shadow-lg opacity-0 invisible transition-all" data-language-dropdown>
                {availableLocales.map(l => (
                  <a
                    href={`/${l}/`}
                    class={`flex items-center gap-2 px-3 py-1.5 text-sm ${l === locale ? 'text-[var(--color-primary)] bg-[var(--color-primary)]/5' : 'text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] hover:bg-[var(--color-background-secondary)]'}`}
                  >
                    <span class="font-medium w-6">{l.toUpperCase()}</span>
                    <span class="text-[var(--color-text-muted)]">{localeNames[l]}</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Theme toggle -->
          <button
            id="theme-toggle"
            class="p-2 rounded-lg text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] hover:bg-[var(--color-background-secondary)]"
          >
            <Icon name="sun" className="w-5 h-5 hidden dark:block" aria-hidden={true} client:only="react" />
            <Icon name="moon" className="w-5 h-5 block dark:hidden" aria-hidden={true} client:only="react" />
          </button>

          <a href={localizeUrl('/')} class="btn btn-primary">
            Go home
          </a>
        </div>
      </div>
    </header>

    <!-- 404 Content -->
    <main class="pt-32 pb-20 px-6">
      <div id="not-found-content" class="max-w-3xl mx-auto text-center transition-all duration-300">
        <!-- 404 Header -->
        <div id="header-404" class="mb-12 transition-all duration-300">
          <h1 class="text-5xl font-bold text-[var(--color-text-primary)] mb-4">
            Page not found
          </h1>
          <div class="text-sm font-medium text-[var(--color-primary)] uppercase tracking-wider mb-8">404 Error</div>
          
          <p class="text-[var(--color-text-secondary)] text-lg mb-12">
            The page you're looking for doesn't exist or has been moved.
            Check the URL or try searching for what you need.
          </p>
        </div>

        <!-- ChatGPT-style Search -->
        <div id="search-container-404" class="max-w-2xl mx-auto mb-12 transition-all duration-300 sticky top-4 z-40">
          <div class="relative group">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <Icon name="search" className="w-5 h-5 text-[var(--color-text-muted)] group-focus-within:text-[var(--color-primary)] transition-colors" aria-hidden={true} client:only="react" />
            </div>
            <input
              type="text"
              id="search-input-404"
              class="w-full pl-12 pr-4 py-4 bg-[var(--color-background-secondary)] border border-[var(--color-border)] rounded-2xl text-[var(--color-text-primary)] placeholder-[var(--color-text-muted)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]/20 focus:border-[var(--color-primary)] transition-all text-lg shadow-sm"
              placeholder="Try find here..."
              autocomplete="off"
            />
          </div>
        </div>

        <!-- Default Actions (hidden when searching) -->
        <div id="default-actions" class="flex flex-col sm:flex-row items-center justify-center gap-4 transition-all duration-300">
          <a href={localizeUrl('/')} class="btn btn-primary w-full sm:w-auto">
            <Icon name="home" className="w-4 h-4" aria-hidden={true} client:only="react" />
            Go to homepage
          </a>
        </div>

        <!-- Search Results (hidden by default) -->
        <div id="search-results-404" class="hidden text-left mt-8">
          <!-- Results will be injected here -->
        </div>
      </div>
    </main>

    <!-- Footer (same as home page) -->
    <footer class="mt-auto py-12 px-6 border-t border-[var(--color-border)]">
      <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center gap-6">
          <div class="flex items-center gap-2">
            {(settings?.appearance?.branding?.logo || settings?.appearance?.logoUrl) ? (
              <>
                <img
                  src={settings?.appearance?.branding?.logo || settings?.appearance?.logoUrl}
                  alt={siteName}
                  class={`h-6 w-auto opacity-50 ${settings?.appearance?.branding?.logoDark ? 'dark:hidden' : ''}`}
                />
                {settings?.appearance?.branding?.logoDark && (
                  <img
                    src={settings?.appearance?.branding?.logoDark}
                    alt={siteName}
                    class="h-6 w-auto opacity-50 hidden dark:block"
                  />
                )}
              </>
            ) : (
              <span class="text-[var(--color-text-muted)]">{siteName}</span>
            )}
          </div>

          <p class="text-sm text-[var(--color-text-muted)]">
            {footerTagline}
          </p>

          <div class="flex items-center gap-4">
            {socialLinks.length > 0 ? (
              socialLinks.map(social => (
                <a
                  href={social.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)]"
                  title={social.name}
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d={socialIcons[social.icon] || socialIcons.github} />
                  </svg>
                </a>
              ))
            ) : (
              <>
                <a href="https://github.com" target="_blank" rel="noopener noreferrer" class="text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)]">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d={socialIcons.github} />
                  </svg>
                </a>
                <a href="https://twitter.com" target="_blank" rel="noopener noreferrer" class="text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)]">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d={socialIcons.twitter} />
                  </svg>
                </a>
              </>
            )}
          </div>
        </div>
      </div>
    </footer>
  </div>
</BaseLayout>

<style is:global>
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 0.75rem;
    font-weight: 600;
    transition: all 0.2s;
    text-decoration: none;
    font-size: 0.9375rem;
  }

  .btn-primary {
    background: var(--color-primary);
    color: white;
  }

  .btn-primary:hover {
    filter: brightness(0.9);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(var(--color-primary-rgb, 99, 102, 241), 0.2);
    color: white;
  }

  .btn-secondary {
    background: var(--color-background-secondary);
    color: var(--color-text-primary);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-background-tertiary);
    border-color: var(--color-text-muted);
  }

  .language-selector.open .language-dropdown {
    opacity: 1;
    visibility: visible;
  }

  /* ---- Search Results Styles (Matching SearchButton.astro) ---- */
  .search-answer-card {
    padding: 1rem;
    border-radius: 1rem;
    margin-bottom: 1.25rem;
    background: linear-gradient(135deg,
      rgba(var(--color-primary-rgb, 99, 102, 241), 0.04) 0%,
      rgba(var(--color-primary-rgb, 99, 102, 241), 0.01) 100%
    );
    border: 1px solid rgba(var(--color-primary-rgb, 99, 102, 241), 0.1);
    animation: search-fade-in 0.3s ease;
  }

  .dark .search-answer-card {
    background: linear-gradient(135deg,
      rgba(var(--color-primary-rgb, 99, 102, 241), 0.08) 0%,
      rgba(var(--color-primary-rgb, 99, 102, 241), 0.02) 100%
    );
    border-color: rgba(var(--color-primary-rgb, 99, 102, 241), 0.15);
  }

  .search-answer-header {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    margin-bottom: 0.625rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-primary, #6366f1);
  }

  .search-answer-icon {
    width: 0.875rem;
    height: 0.875rem;
  }

  .search-answer-body {
    font-size: 0.8125rem;
    line-height: 1.6;
    color: var(--color-text-primary);
  }

  .search-answer-body p {
    margin: 0 0 0.5rem;
  }

  .search-answer-body p:last-child {
    margin-bottom: 0;
  }

  .search-answer-body code {
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    background: var(--color-background-tertiary);
    font-size: 0.75rem;
    font-family: ui-monospace, 'SF Mono', SFMono-Regular, 'Cascadia Code', 'Liberation Mono', Menlo, monospace;
  }

  .search-answer-body pre {
    margin: 0.5rem 0;
    padding: 0.75rem;
    border-radius: 0.5rem;
    background: var(--color-background-tertiary);
    overflow-x: auto;
  }

  .search-answer-body pre code {
    padding: 0;
    background: none;
    font-size: 0.75rem;
  }

  .search-answer-body strong {
    font-weight: 600;
    color: var(--color-text-primary);
  }

  .search-answer-body ul, .search-answer-body ol {
    margin: 0.375rem 0;
    padding-left: 1.25rem;
  }

  .search-answer-body li {
    margin-bottom: 0.25rem;
  }

  .search-md-link {
    color: var(--color-primary, #6366f1);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .search-sources-section {
    padding: 0.5rem 0.25rem;
    animation: search-fade-in 0.3s ease;
  }

  .search-sources-label {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
  }

  .search-sources-label svg {
    width: 0.8125rem;
    height: 0.8125rem;
  }

  .search-sources-grid {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .search-source-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.75rem;
    border-radius: 0.625rem;
    text-decoration: none;
    color: var(--color-text-primary);
    transition: all 0.15s ease;
    cursor: pointer;
  }

  .search-source-card:hover {
    background: var(--color-background-secondary, #f8f9fa);
  }

  .dark .search-source-card:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .search-source-card-icon {
    flex-shrink: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    background: var(--color-background-tertiary);
    color: var(--color-text-muted);
  }

  .search-source-card-icon svg {
    width: 1.125rem;
    height: 1.125rem;
  }

  .search-source-card-body {
    flex: 1;
    min-width: 0;
  }

  .search-source-card-title {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-source-card-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.125rem;
  }

  .search-source-breadcrumb {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 0.125rem;
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    margin-bottom: 0.125rem;
    opacity: 0.9;
    white-space: nowrap;
    overflow: hidden;
  }

  .search-breadcrumb-item {
    flex-shrink: 0;
  }

  .search-breadcrumb-sep {
    display: inline-block;
    width: 8px;
    height: 8px;
    min-width: 8px;
    min-height: 8px;
    color: var(--color-text-muted);
    opacity: 0.8;
    flex-shrink: 0;
    margin: 0 0.125rem;
    vertical-align: middle;
  }

  .search-source-card-snippet {
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-source-card-arrow {
    flex-shrink: 0;
    width: 1rem;
    height: 1rem;
    color: var(--color-text-muted);
    opacity: 0;
    transition: all 0.15s ease;
  }

  .search-source-card:hover .search-source-card-arrow {
    opacity: 1;
    transform: translateX(2px);
  }

  .search-ai-loading {
    animation: search-fade-in 0.3s ease;
  }

  .search-answer-card--loading {
    opacity: 0.85;
  }

  .search-answer-card--loading .search-answer-header {
    animation: search-ai-pulse 2s ease-in-out infinite;
  }

  @keyframes search-ai-pulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
  }

  @keyframes search-fade-in {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .search-highlight {
    background: rgba(var(--color-primary-rgb, 99, 102, 241), 0.15);
    color: var(--color-primary, #6366f1);
    border-radius: 0.125rem;
    padding: 0 0.0625rem;
  }

  .dark .search-highlight {
    background: rgba(var(--color-primary-rgb, 99, 102, 241), 0.25);
  }

  .search-answer-sources {
    margin-top: 0.625rem;
    padding-top: 0.5rem;
    border-top: 1px solid rgba(var(--color-primary-rgb, 99, 102, 241), 0.08);
    display: flex;
    align-items: center;
    gap: 0.375rem;
    flex-wrap: wrap;
  }

  .search-answer-sources-label {
    font-size: 0.5625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    opacity: 0.6;
  }

  .search-answer-sources-list {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
  }

  .search-answer-source-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    background: rgba(var(--color-primary-rgb, 99, 102, 241), 0.06);
    text-decoration: none;
    transition: all 0.15s ease;
    max-width: 12rem;
    overflow: hidden;
  }

  .search-answer-source-pill:hover {
    background: rgba(var(--color-primary-rgb, 99, 102, 241), 0.12);
  }

  .search-answer-source-title {
    font-size: 0.5625rem;
    font-weight: 500;
    color: var(--color-primary, #6366f1);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-no-results,
  .search-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2.5rem 1rem;
    gap: 0.375rem;
    color: var(--color-text-muted);
  }

  .search-no-results svg,
  .search-error svg {
    width: 2rem;
    height: 2rem;
    opacity: 0.4;
    margin-bottom: 0.25rem;
  }
</style>

<script>
  // Language selector dropdown toggle
  document.querySelectorAll('[data-language-selector]').forEach(selector => {
    const toggle = selector.querySelector('[data-language-toggle]');
    toggle?.addEventListener('click', (e) => {
      e.stopPropagation();
      selector.classList.toggle('open');
    });
  });

  // Close dropdowns on outside click
  document.addEventListener('click', () => {
    document.querySelectorAll('[data-language-selector]').forEach(s => s.classList.remove('open'));
  });

  // --- Search Functionality ---
  function initSearch404() {
    const searchInput = document.getElementById('search-input-404') as HTMLInputElement | null;
    const searchResults = document.getElementById('search-results-404');
    const defaultActions = document.getElementById('default-actions');
    const header404 = document.getElementById('header-404');
    const searchContainer = document.getElementById('search-container-404');
    const siteHeader = document.getElementById('site-header');
    const container = document.querySelector('[data-cms-url]') as HTMLElement | null;

    if (!searchInput || !searchResults || !defaultActions || !container) return;

    const CMS_URL = container.dataset.cmsUrl || '';
    const CMS_API_KEY = container.dataset.cmsApiKey || '';
    const collectionIcons = JSON.parse(container.dataset.collectionIcons || '{}');
    const locale = document.documentElement.lang || 'en';

    let debounceTimer: ReturnType<typeof setTimeout> | null = null;
    let currentRequest: AbortController | null = null;
    let currentQuery = '';

    // Toggle view when searching
    function toggleSearchView(isSearching: boolean) {
      if (isSearching) {
        if (defaultActions) defaultActions.style.display = 'none';
        if (header404) header404.style.display = 'none';
        if (searchContainer) {
          searchContainer.classList.remove('mb-12');
          searchContainer.classList.add('mb-4');
        }
        if (siteHeader) {
          siteHeader.style.transform = 'translateY(-100%)';
        }
      } else {
        if (defaultActions) defaultActions.style.display = 'flex';
        if (header404) header404.style.display = 'block';
        if (searchContainer) {
          searchContainer.classList.add('mb-12');
          searchContainer.classList.remove('mb-4');
        }
        if (siteHeader) {
          siteHeader.style.transform = 'translateY(0)';
        }
        if (searchResults) {
          searchResults.classList.add('hidden');
          searchResults.innerHTML = '';
        }
      }
    }

    const iconMap: Record<string, string> = {
      'sparkles': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>',
      'search': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>',
      'arrow-right': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>',
      'alert-circle': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>'
    };

    function getCollectionIcon(collectionId: string) {
      // Check if CMS provided an icon for this collection
      const cmsIconName = collectionIcons[collectionId];
      
      const iconSvgs: Record<string, string> = {
        'book': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>',
        'file-text': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
        'message-square': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
        'code': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>',
        'layers': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>',
        'zap': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>',
        'star': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
        'box': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>',
        'layout': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>',
        'settings': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>',
        'guides': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3Z"/><path d="M7 3V21M3 7H7M3 12H7M3 17H7" stroke-linecap="round"/></svg>',
        'api': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M13.5 6L10 18.5M6.5 8.5L3 12L6.5 15.5M17.5 8.5L21 12L17.5 15.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        'reference': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 10C3 6.22876 3 4.34315 4.17157 3.17157C5.34315 2 7.22876 2 11 2H13C16.7712 2 18.6569 2 19.8284 3.17157C21 4.34315 21 6.22876 21 10V14C21 17.7712 21 19.6569 19.8284 20.8284C18.6569 22 16.7712 22 13 22H11C7.22876 22 5.34315 22 4.17157 20.8284C3 19.6569 3 17.7712 3 14V10Z"/><path d="M8 7H16M8 12H16M8 17H12" stroke-linecap="round"/></svg>',
        'scroll': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 10C3 6.22876 3 4.34315 4.17157 3.17157C5.34315 2 7.22876 2 11 2H13C16.7712 2 18.6569 2 19.8284 3.17157C21 4.34315 21 6.22876 21 10V14C21 17.7712 21 19.6569 19.8284 20.8284C18.6569 22 16.7712 22 13 22H11C7.22876 22 5.34315 22 4.17157 20.8284C3 19.6569 3 17.7712 3 14V10Z"/><path d="M8 7H16M8 12H16M8 17H12" stroke-linecap="round"/></svg>',
        'fileText': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 10C3 6.22876 3 4.34315 4.17157 3.17157C5.34315 2 7.22876 2 11 2H13C16.7712 2 18.6569 2 19.8284 3.17157C21 4.34315 21 6.22876 21 10V14C21 17.7712 21 19.6569 19.8284 20.8284C18.6569 22 16.7712 22 13 22H11C7.22876 22 5.34315 22 4.17157 20.8284C3 19.6569 3 17.7712 3 14V10Z"/><path d="M8 7H16M8 12H16M8 17H12" stroke-linecap="round"/></svg>',
        'fileCode': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M13.5 6L10 18.5M6.5 8.5L3 12L6.5 15.5M17.5 8.5L21 12L17.5 15.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        'folder': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 10C3 7.17157 3 5.75736 3.87868 4.87868C4.75736 4 6.17157 4 9 4H10C10.5304 4 10.7956 4 11.0405 4.06189C11.2854 4.12377 11.511 4.24757 11.962 4.49515L12.538 4.81165C12.989 5.05923 13.2146 5.18301 13.4595 5.2449C13.7044 5.30678 13.9696 5.30678 14.5 5.30678H15C17.8284 5.30678 19.2426 5.30678 20.1213 6.18546C21 7.06414 21 8.47835 21 11.3068V14C21 16.8284 21 18.2426 20.1213 19.1213C19.2426 20 17.8284 20 15 20H9C6.17157 20 4.75736 20 3.87868 19.1213C3 18.2426 3 16.8284 3 14V10Z"/></svg>',
        'document': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 10C3 6.22876 3 4.34315 4.17157 3.17157C5.34315 2 7.22876 2 11 2H13C16.7712 2 18.6569 2 19.8284 3.17157C21 4.34315 21 6.22876 21 10V14C21 17.7712 21 19.6569 19.8284 20.8284C18.6569 22 16.7712 22 13 22H11C7.22876 22 5.34315 22 4.17157 20.8284C3 19.6569 3 17.7712 3 14V10Z"/><path d="M8 7H16M8 12H16M8 17H12" stroke-linecap="round"/></svg>',
      };

      // Use CMS icon name if it exists in our SVG map
      if (cmsIconName && iconSvgs[cmsIconName]) {
        return iconSvgs[cmsIconName];
      }

      // Fallback to collection name based mapping
      if (iconSvgs[collectionId]) {
        return iconSvgs[collectionId];
      }

      // Default to file-text icon
      return iconSvgs['file-text'];
    }

    function escapeHtml(str: string): string {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function highlightKeywords(text: string, query: string): string {
      if (!query) return escapeHtml(text);
      const escaped = escapeHtml(text);
      const words = query.toLowerCase().split(/\s+/).filter(w => w.length > 2);
      if (words.length === 0) return escaped;
      const pattern = words.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
      const regex = new RegExp(`(${pattern})`, 'gi');
      return escaped.replace(regex, '<mark class="search-highlight">$1</mark>');
    }

    function simpleMarkdown(text: string): string {
      let processed = text
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="search-md-link">$1</a>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
      return `<p>${processed}</p>`;
    }

    function getBreadcrumb(doc: any) {
      const parts = [];
      if (doc.collectionTitle) parts.push(doc.collectionTitle);
      if (doc.categoryTitle) parts.push(doc.categoryTitle);
      return parts.map(p => `<span class="search-breadcrumb-item">${escapeHtml(p)}</span>`).join('<span class="search-breadcrumb-sep">/</span>');
    }

    function resetResults() {
      if (searchResults) {
        searchResults.innerHTML = '';
        searchResults.classList.add('hidden');
      }
      if (defaultActions) {
        defaultActions.classList.remove('hidden');
      }
    }

    function showLoading() {
      if (searchResults) {
        searchResults.classList.remove('hidden');
        searchResults.innerHTML = `
          <div class="search-ai-loading">
            <div class="search-answer-card search-answer-card--loading">
              <div class="search-answer-header">
                <span class="search-answer-icon">${iconMap['sparkles']}</span>
                <span>Thinking...</span>
              </div>
              <div class="search-answer-body">
                <div class="flex flex-col gap-2">
                  <div class="h-4 bg-[var(--color-background-tertiary)] rounded-md w-full animate-pulse"></div>
                  <div class="h-4 bg-[var(--color-background-tertiary)] rounded-md w-[90%] animate-pulse"></div>
                  <div class="h-4 bg-[var(--color-background-tertiary)] rounded-md w-[70%] animate-pulse"></div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      if (defaultActions) {
        defaultActions.classList.add('hidden');
      }
    }

    function renderResults(answer: string, sources: any[], query: string, showAiLoading = false) {
      if (!searchResults) return;
      
      let html = '';

      // AI Answer Section
      if (answer || showAiLoading) {
        html += `
          <div class="search-answer-card ${showAiLoading ? 'search-answer-card--loading' : ''}">
            <div class="search-answer-header">
              <span class="search-answer-icon">
                <svg viewBox="0 0 22 22" fill="none">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M7.517 8.773L13 19.772l-5.5-1.343L2 19.772l5.515-10.999h.002z" fill="currentColor"/>
                  <path d="M16.596 7s.237 2.217 1.162 3.142c.925.925 3.142 1.162 3.142 1.162s-2.217.238-3.142 1.163c-.925.925-1.162 3.141-1.162 3.141s-.238-2.216-1.163-3.141c-.925-.926-3.142-1.163-3.142-1.163s2.217-.237 3.142-1.162C16.358 9.217 16.596 7 16.596 7z" fill="currentColor"/>
                  <path d="M13.726 4s.132 1.232.646 1.745c.514.514 1.746.646 1.746.646s-1.232.132-1.746.646c-.514.514-.646 1.745-.646 1.745s-.132-1.231-.646-1.745c-.514-.514-1.745-.646-1.745-.646s1.231-.132 1.745-.646c.514-.514.646-1.745.646-1.745z" fill="currentColor"/>
                  <path d="M18.509 3s.08.739.388 1.047c.308.308 1.047.387 1.047.387s-.739.08-1.047.388c-.308.308-.388 1.047-.388 1.047s-.079-.739-.387-1.047c-.309-.309-1.048-.388-1.048-.388s.74-.079 1.048-.387c.308-.308.387-1.047.387-1.047z" fill="currentColor"/>
                </svg>
              </span>
              <span>AI Answer</span>
            </div>
            <div class="search-answer-body">
              ${showAiLoading ? `
                <div class="search-loading" style="padding: 0.5rem 0; justify-content: flex-start;">
                  <div class="search-loading-dots"><span></span><span></span><span></span></div>
                  <span class="search-loading-text">Generating AI answer...</span>
                </div>
              ` : simpleMarkdown(answer)}
            </div>
            ${!showAiLoading && sources.length > 0 ? `
              <div class="search-answer-sources">
                <span class="search-answer-sources-label">Sources:</span>
                <div class="search-answer-sources-list">
                  ${sources.slice(0, 3).map((s) => {
                    const href = s.slug ? `/${s.locale || locale}/${s.slug}` : s.url || '#';
                    return `
                      <a href="${href}" class="search-answer-source-pill">
                        <span class="search-answer-source-title">${escapeHtml(s.title)}</span>
                      </a>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }

      // Sources Section
      if (sources.length > 0) {
        html += `
          <div class="search-sources-section">
            <div class="search-sources-label">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 19.5A2.5 2.5 0 016.5 17H20"/>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>
              </svg>
              <span>Related docs</span>
            </div>
            <div class="search-sources-grid">
              ${sources.slice(0, 6).map(doc => {
                let href = doc.slug ? `/${doc.locale || locale}/${doc.slug}` : doc.url || '#';
                const collectionIndexes = ['docs', 'academy', 'insights', 'roadmap', 'glossary', 'answers', 'product-updates', 'about'];
                if (doc.slug && collectionIndexes.includes(doc.slug) && !href.endsWith('/')) {
                  href += '/';
                }

                return `
                  <a href="${href}" class="search-source-card">
                    <div class="search-source-card-icon">
                      ${getCollectionIcon(doc.collectionId || doc.collection)}
                    </div>
                    <div class="search-source-card-body">
                      <div class="search-source-card-title">
                        ${highlightKeywords(doc.title, query)}
                      </div>
                      <div class="search-source-card-meta">
                        <div class="search-source-breadcrumb">
                          ${getBreadcrumb(doc)}
                        </div>
                      </div>
                      ${doc.snippet ? `
                        <div class="search-source-card-snippet">
                          ${highlightKeywords(doc.snippet, query)}
                        </div>
                      ` : ''}
                    </div>
                    <div class="search-source-card-arrow">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"/>
                      </svg>
                    </div>
                  </a>
                `;
              }).join('')}
            </div>
          </div>
        `;
      } else if (!answer && !showAiLoading) {
        html = `
          <div class="search-no-results">
            ${iconMap['alert-circle']}
            <p>No results found for "${escapeHtml(query)}"</p>
          </div>
        `;
      }

      searchResults.innerHTML = html;
    }

    async function performSearch(query: string) {
      if (!query.trim()) {
        resetResults();
        return;
      }

      currentQuery = query.trim();
      if (currentRequest) currentRequest.abort();
      currentRequest = new AbortController();
      const signal = currentRequest.signal;

      showLoading();

      const headers: Record<string, string> = { 'Content-Type': 'application/json' };
      if (CMS_API_KEY) headers['x-api-key'] = CMS_API_KEY;

      try {
        // Phase 1: Fast document search (instant results)
        const searchRes = await fetch(`${CMS_URL}/api/ai/search-docs`, {
          method: 'POST',
          headers,
          signal,
          body: JSON.stringify({ query, locale })
        });

        if (signal.aborted) return;

        if (searchRes.ok) {
          const searchData = await searchRes.json();
          const sources = searchData.sources || [];
          // Render sources immediately + AI loading indicator
          renderResults('', sources, query, true);
        }

        // Phase 2: AI-generated answer (slower)
        const chatRes = await fetch(`${CMS_URL}/api/ai/chat-rag`, {
          method: 'POST',
          headers,
          signal,
          body: JSON.stringify({ message: query, locale })
        });

        if (signal.aborted) return;
        
        if (chatRes.ok) {
          const chatData = await chatRes.json();
          renderResults(chatData.answer || '', chatData.sources || [], query, false);
        } else {
          // If AI fails but we have sources from phase 1, keep them
          const existingSources = searchResults && searchResults.querySelectorAll('.search-source-card').length > 0;
          if (existingSources) {
            // Just remove the AI loading card
            const loadingCard = searchResults && searchResults.querySelector('.search-answer-card--loading');
            if (loadingCard) loadingCard.remove();
          } else {
            throw new Error('Search failed');
          }
        }

      } catch (err: any) {
        if (err.name === 'AbortError') return;
        if (searchResults) {
          searchResults.innerHTML = `
            <div class="search-error">
              ${iconMap['alert-circle']}
              <p>Failed to find results. Please try again.</p>
            </div>
          `;
        }
      }
    }

    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.trim();
      
      if (debounceTimer) clearTimeout(debounceTimer);
      
      if (query.length > 2) {
        toggleSearchView(true);
        debounceTimer = setTimeout(() => performSearch(query), 300);
      } else if (query.length === 0) {
        toggleSearchView(false);
      }
    });
  }

  initSearch404();
  document.addEventListener('astro:after-swap', initSearch404);
</script>
